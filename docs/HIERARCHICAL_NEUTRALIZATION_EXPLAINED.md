# 階層式中性化（Hierarchical Neutralization）詳解

## 🎯 核心問題：股票報酬的三層結構

當一檔股票上漲時，這個漲幅可以拆解為三個部分：

```
總報酬 = 市場效應 + 產業效應 + 個股效應
```

### 實際範例（2024 年某一天）

假設今天台積電漲了 **+3.5%**，我們來拆解：

#### 1. 市場效應（Market Effect）
- 今天台股大盤（加權指數）漲了 **+1.0%**
- 這是「整體市場」的漲幅，所有股票都受影響
- **市場效應 = +1.0%**

#### 2. 產業效應（Industry Effect）
- 整個半導體產業平均漲了 **+2.0%**
- 這是因為「半導體產業」的利多消息（如訂單增加、AI 需求旺盛）
- **產業效應 = +2.0% - 1.0% = +1.0%**（產業漲幅 - 市場漲幅）

#### 3. 個股效應（Stock-Specific Effect）
- 台積電因為「自己的原因」額外漲了 **+0.5%**
- 這可能是：新技術突破、大客戶增單、財報超預期等
- **個股效應 = +3.5% - 2.0% = +1.5%**（總漲幅 - 產業漲幅）

### 拆解結果

```
台積電 +3.5% = 市場 +1.0% + 產業 +1.0% + 個股 +1.5%
             = 整體市況   + 半導體熱   + 台積電本身優勢
```

---

## 🎓 為什麼要做中性化？

### 問題：預測不準的原因

如果我們直接預測「總報酬 +3.5%」，會遇到問題：

#### 問題 1：過度依賴市場和產業
```python
# 錯誤的預測邏輯
if 大盤在漲:
    預測所有股票都漲  # ← 太粗糙！

if 半導體產業在漲:
    預測台積電、聯發科都漲  # ← 忽略個股差異！
```

**結果：** 模型只學會「跟風」，沒有真正的選股能力。

#### 問題 2：泛化能力差

訓練期：多頭市場（市場 +1%，產業 +2%）
→ 模型學會：看到半導體就預測 +3%

測試期：空頭市場（市場 -1%，產業 -2%）
→ 模型仍預測 +3%，**完全錯誤！**

### 解決方案：階層式中性化

**核心思想：** 逐層剝離市場和產業的影響，只預測「個股超額表現」

```
原始預測目標：總報酬 +3.5%（容易過擬合）
↓ 中性化後
新預測目標：個股效應 +1.5%（更穩定、更有意義）
```

---

## 🏗️ 階層式中性化架構

### 完整流程圖

```
輸入：56 個原始特徵（技術指標、財務數據）
    ↓
┌─────────────────────────────────────────┐
│ Step 1: 特徵編碼（Feature Encoding）    │
└─────────────────────────────────────────┘
    ↓
[BatchNorm] → 標準化（去除量綱差異）
    ↓
[MLP] → 編碼為 64 維隱藏特徵
    ↓
編碼特徵 C [N, 64]  ← 第一種特徵（包含所有信息）


┌─────────────────────────────────────────┐
│ Step 2: 產業中性化                       │
│ (Industry Neutralization)               │
└─────────────────────────────────────────┘
    ↓
[GAT on 產業圖] → 學習「產業內的共同影響」
    產業圖：同產業股票互相連接
    範例：台積電 ↔ 聯發科 ↔ 日月光
    ↓
產業影響 H_I [N, 64]
    ↓
C - H_I = C_I [N, 64]  ← 第二種特徵（產業中性化）

    移除了「產業共同漲跌」
    保留了「個股相對產業的超額表現」


┌─────────────────────────────────────────┐
│ Step 3: 全市場中性化                     │
│ (Universe Neutralization)               │
└─────────────────────────────────────────┘
    ↓
[GAT on 全市場圖] → 學習「全市場的共同影響」
    全市場圖：所有股票互相連接（全連接）
    學習：「大盤多頭/空頭」的共同趨勢
    ↓
    ⚠️ 注意：輸入是 C_I（產業中性化後），不是 C！
    ↓
全市場影響 H_U [N, 64]
    ↓
C_I - H_U = C_U [N, 64]  ← 第三種特徵（全市場中性化）

    移除了「產業 + 市場的共同漲跌」
    只保留「純個股效應」


┌─────────────────────────────────────────┐
│ Step 4: 階層式特徵拼接                   │
└─────────────────────────────────────────┘
    ↓
[C || C_I || C_U]  → 拼接為 [N, 192]

    讓模型同時看到三種層次的信息：
    - C:   原始特徵（市場 + 產業 + 個股）
    - C_I: 產業中性（市場 + 個股）
    - C_U: 全市場中性（純個股）


┌─────────────────────────────────────────┐
│ Step 5: 深度因子學習                     │
└─────────────────────────────────────────┘
    ↓
[MLP Decoder]
    ↓
深度因子 f [N, 1]  → 預測報酬率
```

---

## 💡 具體範例：逐步拆解

### 假設場景（2024-11-20）

**市場狀況：**
- 台股大盤：+1.2%
- 半導體產業：+2.5%
- 台積電：+4.0%
- 聯發科：+3.0%
- 日月光：+2.8%

---

### Step 1: 編碼特徵 C

```python
# 輸入：台積電的 56 個特徵
原始特徵 = [
    ret_10 = 0.15,      # 近 10 日漲 15%
    rsi_14 = 75,        # RSI 指標 75（偏高）
    px_over_sma_20 = 0.08,  # 價格超過 20 日均線 8%
    ...
]

# 經過 BatchNorm + MLP
C_台積電 = [0.82, -0.35, 1.24, ..., 0.67]  # [64 維]
```

**C 包含什麼？**
- 所有信息（市場 + 產業 + 個股）
- 編碼後的抽象表示

---

### Step 2: 產業中性化（C → C_I）

#### GAT 學習產業影響

```python
# 產業圖：半導體產業的股票互相連接
產業圖 = {
    台積電 ↔ 聯發科,
    台積電 ↔ 日月光,
    聯發科 ↔ 日月光
}

# GAT 聚合同產業股票的特徵
H_I_台積電 = GAT_Industry(
    C_台積電,
    neighbors=[C_聯發科, C_日月光]
)

# 結果：H_I 代表「半導體產業的共同特徵」
H_I_台積電 = [0.65, -0.28, 1.10, ..., 0.55]
```

**H_I 學到了什麼？**
- 半導體產業「共同的漲跌趨勢」
- 如：AI 訂單增加、產能利用率提升

#### 產業中性化：移除產業影響

```python
# C_I = C - H_I
C_I_台積電 = C_台積電 - H_I_台積電
           = [0.82, -0.35, 1.24, ..., 0.67]
           - [0.65, -0.28, 1.10, ..., 0.55]
           = [0.17, -0.07, 0.14, ..., 0.12]
```

**C_I 包含什麼？**
- 移除了「半導體產業共同漲 2.5%」的影響
- 保留了「台積電相對產業的超額表現 +1.5%」

**金融解讀：**
```
原始：台積電 +4.0%
產業中性化後：台積電 +1.5%（超越產業平均）

聯發科：+3.0%
產業中性化後：+0.5%（略低於產業平均）

日月光：+2.8%
產業中性化後：+0.3%（低於產業平均）
```

---

### Step 3: 全市場中性化（C_I → C_U）

#### GAT 學習全市場影響

```python
# 全市場圖：所有 771 檔股票互相連接
全市場圖 = {
    台積電 ↔ 所有股票
}

# ⚠️ 注意：輸入是 C_I（已經產業中性化）
H_U_台積電 = GAT_Universe(
    C_I_台積電,
    neighbors=[C_I_所有股票]
)

# 結果：H_U 代表「全市場的共同趨勢」
H_U_台積電 = [0.12, -0.05, 0.09, ..., 0.08]
```

**H_U 學到了什麼？**
- 整體市場「多頭/空頭」的共同趨勢
- 如：大盤漲 +1.2%，所有股票都受益

#### 全市場中性化：移除市場影響

```python
# C_U = C_I - H_U
C_U_台積電 = C_I_台積電 - H_U_台積電
           = [0.17, -0.07, 0.14, ..., 0.12]
           - [0.12, -0.05, 0.09, ..., 0.08]
           = [0.05, -0.02, 0.05, ..., 0.04]
```

**C_U 包含什麼？**
- 移除了「市場 +1.2% + 產業 +1.3%」的影響
- **只保留「純個股效應」**

**金融解讀：**
```
原始報酬：台積電 +4.0%
拆解：
  - 市場效應：+1.2%
  - 產業效應：+1.3%（2.5% - 1.2%）
  - 個股效應：+1.5%（4.0% - 2.5%）

全市場中性化後：
  C_U 代表「個股效應 +1.5%」
```

---

### Step 4: 階層式特徵拼接

```python
# 拼接三種特徵
hierarchical_features = torch.cat([C, C_I, C_U], dim=-1)
                      = [64 維 | 64 維 | 64 維] = [192 維]
```

**為什麼要拼接？**

讓模型同時看到三種層次的信息：

| 特徵 | 包含信息 | 用途 |
|------|---------|------|
| **C** | 市場 + 產業 + 個股 | 全局視角，掌握整體趨勢 |
| **C_I** | 市場 + 個股 | 產業內比較，選出產業龍頭 |
| **C_U** | 純個股 | 挖掘個股獨特優勢 |

**範例：**

```python
# 模型可以學習不同策略：

# 策略 1：順勢策略（使用 C）
if C 顯示「市場 + 產業都在漲」:
    預測 +3.0%  # 跟隨大趨勢

# 策略 2：產業輪動（使用 C_I）
if C_I 顯示「台積電在產業內表現強」:
    預測 +1.5%  # 選產業龍頭

# 策略 3：個股挖掘（使用 C_U）
if C_U 顯示「台積電有獨特優勢」:
    預測 +1.0%  # 挖掘個股價值
```

---

## 🔬 數學原理

### 產業中性化（Industry Neutralization）

#### 公式

```
H_I = GAT(C, Industry_Graph)
C_I = C - H_I
```

#### 展開

```python
# GAT 聚合函數
H_I[i] = Σ_{j ∈ Industry(i)} α_ij · C[j]

其中：
- Industry(i)：股票 i 的同產業股票集合
- α_ij：注意力權重（學習出來的）
```

#### 金融解釋

```
H_I[台積電] = 半導體產業的「平均特徵」（加權）
           ≈ 0.4 · C[台積電] + 0.3 · C[聯發科] + 0.3 · C[日月光]

C_I[台積電] = C[台積電] - H_I[台積電]
           = 「台積電的獨特性」
```

---

### 全市場中性化（Universe Neutralization）

#### 公式

```
H_U = GAT(C_I, Universe_Graph)  # ← 注意：輸入是 C_I
C_U = C_I - H_U
```

#### 為什麼輸入是 C_I？

**關鍵：階層式設計**

```
如果輸入 C（錯誤）：
  H_U 會學到「市場 + 產業」的影響
  C_U = C - H_U 只移除一次，無法完全中性化

如果輸入 C_I（正確）：
  H_U 只學到「市場」的影響（產業已在第一步移除）
  C_U = C_I - H_U 完全移除市場影響
```

#### 金融解釋

```
第一層（產業中性化）：
  C_I = C - 產業影響
      = 市場影響 + 個股影響

第二層（全市場中性化）：
  C_U = C_I - 市場影響
      = 個股影響（純淨！）
```

---

## 📊 實際效果驗證

### 變異數降低

理論上，中性化應該降低特徵的變異數（移除共同影響）。

```python
# 實際測試（使用 analyze_contexts.py）

原始特徵 C:
  Mean Variance: 0.8542

產業中性化 C_I:
  Mean Variance: 0.6231
  降低: 27.0%  # ← 移除產業共同波動

全市場中性化 C_U:
  Mean Variance: 0.5124
  降低: 40.0%  # ← 移除市場 + 產業共同波動
```

### 影響力大小比較

```python
# H_I（產業影響）vs H_U（市場影響）

產業影響 ||H_I||:
  Mean: 0.4523
  Std:  0.1234

全市場影響 ||H_U||:
  Mean: 0.3215
  Std:  0.0987

解釋：
  產業影響 > 市場影響
  → 產業分類對股票更重要
```

---

## 💼 實際應用場景

### 場景 1：多頭市場選股

```
市場狀況：大盤漲 +2%

策略 A（不中性化）：
  模型預測：所有股票都漲 +2%
  結果：無選股能力，報酬 = 大盤

策略 B（階層式中性化）：
  模型預測：個股超額報酬
  - 台積電：+1.5%（超額）
  - 聯發科：+0.5%（中等）
  - 某公司：-0.5%（弱勢）

  選股：買台積電、聯發科
  報酬：大盤 +2% + 超額 +1.0% = +3.0%
```

---

### 場景 2：空頭市場選股

```
市場狀況：大盤跌 -2%

策略 A（不中性化）：
  模型在多頭市場訓練，預測都是正報酬
  結果：完全失效

策略 B（階層式中性化）：
  模型預測：個股「相對」表現
  - 台積電：-0.5%（相對強）
  - 聯發科：-1.5%（中等）
  - 某公司：-3.0%（弱勢）

  選股：買台積電（跌最少）
  報酬：大盤 -2% + 超額 +1.5% = -0.5%
  → 雖然虧，但比大盤好！
```

---

### 場景 3：產業輪動

```
市場狀況：
  - 電子業：+3%
  - 金融業：-1%

策略 A（不中性化）：
  模型只會選電子股（產業在漲）

策略 B（產業中性化）：
  模型在「每個產業內」選龍頭：
  - 電子業龍頭：台積電（產業內超額 +1%）
  - 金融業龍頭：中信金（產業內超額 +0.8%）

  結果：
  - 台積電：+3% + 1% = +4%
  - 中信金：-1% + 0.8% = -0.2%

  → 即使金融業下跌，仍選出產業內最強股票
```

---

## 🎯 與傳統方法對比

### 傳統因子中性化（Fama-French）

```python
# 線性回歸做中性化
r_i = β_market · r_market + β_industry · r_industry + ε_i

# 取殘差 ε_i 作為個股效應
```

**缺點：**
- 假設線性關係
- 無法捕捉非線性交互作用

---

### DMFM 階層式中性化

```python
# 用 GAT 學習非線性關係
H_I = GAT(C, Industry_Graph)  # 非線性聚合
C_I = C - H_I

H_U = GAT(C_I, Universe_Graph)
C_U = C_I - H_U
```

**優點：**
- **非線性**：GAT 可以學習複雜的關係
- **自適應**：注意力權重自動學習（不同股票權重不同）
- **階層式**：逐層剝離，更乾淨

---

## 📈 視覺化分析

使用 `analyze_contexts.py` 可以生成：

### 1. 變異數降低圖

```
Variance Reduction:

  C (原始)    ████████████████████ 0.85
  C_I (產業)  ████████████ 0.62 (-27%)
  C_U (市場)  ██████████ 0.51 (-40%)
```

### 2. 影響力分布圖

```
Industry Influence (H_I):
  Mean: 0.45
  ████████████████

Universe Influence (H_U):
  Mean: 0.32
  ███████████
```

### 3. PCA 投影

```
C (原始):      ●●●●●●●●●●  (分散)
C_I (產業):    ●●●●●●      (較集中)
C_U (市場):    ●●●●        (更集中)
```

---

## 🔧 實作細節

### 關鍵代碼（model_dmfm_wei2022.py）

```python
def forward(self, x, industry_edge_index, universe_edge_index):
    # Step 1: 編碼
    x_norm = self.batch_norm(x)
    C = self.encoder(x_norm)  # [N, 64]

    # Step 2: 產業中性化
    H_I = self.gat_industry(C, industry_edge_index)  # [N, 64]
    H_I = F.elu(H_I)
    C_I = C - H_I  # ← 產業中性化

    # Step 3: 全市場中性化
    H_U = self.gat_universe(C_I, universe_edge_index)  # ← 輸入 C_I
    H_U = F.elu(H_U)
    C_U = C_I - H_U  # ← 全市場中性化

    # Step 4: 拼接
    hierarchical_features = torch.cat([C, C_I, C_U], dim=-1)  # [N, 192]

    # Step 5: 預測
    deep_factor = self.factor_decoder(hierarchical_features)  # [N, 1]

    return deep_factor, ...
```

---

## ❓ 常見問題

### Q1: 為什麼要用兩個 GAT，不能用一個？

**A:** 階層式設計，逐層剝離：
```
一個 GAT（錯誤）：
  只能學到「市場 + 產業」的混合影響
  無法區分兩者

兩個 GAT（正確）：
  第一個：學習產業影響
  第二個：學習市場影響（在產業已移除的基礎上）
  → 逐層剝離，更乾淨
```

---

### Q2: 為什麼第二個 GAT 輸入是 C_I，不是 C？

**A:** 避免重複學習：
```
如果輸入 C：
  H_U 會同時學到「市場 + 產業」
  C_U = C - H_U 會過度移除（移除兩次產業影響）

如果輸入 C_I：
  H_U 只學到「市場」（產業已在第一步移除）
  C_U = C_I - H_U 只移除一次市場影響
```

---

### Q3: 為什麼要拼接 [C || C_I || C_U]，不是只用 C_U？

**A:** 多層次信息：
```
只用 C_U（錯誤）：
  只看個股效應，忽略市場和產業趨勢
  如：大盤崩盤時，個股再強也很難漲

拼接三者（正確）：
  模型可以綜合考慮：
  - C: 整體趨勢（順勢 or 逆勢）
  - C_I: 產業比較（選產業龍頭）
  - C_U: 個股挖掘（找獨特優勢）
```

---

### Q4: 這個方法適用於所有市場嗎？

**A:** 理論上是，但效果取決於：

```
適合：
  ✓ 產業分類明確（如台股、美股）
  ✓ 產業內股票有相關性
  ✓ 市場有系統性風險

不適合：
  ✗ 產業分類不清（如加密貨幣）
  ✗ 個股完全獨立（如不同國家的小型股）
```

---

## 📚 論文原文（Wei et al. 2022）

### 產業中性化（公式 3-4）

```
H^t_I = GAT(C^t, E_I)
C̄^t_I = C^t - H^t_I
```

### 全市場中性化（公式 5-6）

```
H^t_U = GAT(C̄^t_I, E_U)  # ← 輸入是 C̄^t_I
C̄^t_U = C̄^t_I - H^t_U
```

### 階層式拼接（公式 7）

```
F^t = [C^t || C̄^t_I || C̄^t_U]
```

---

## 🎓 總結

### 核心概念

**階層式中性化 = 逐層剝離市場和產業的影響**

```
原始特徵 C
  ↓ [產業 GAT] 學習產業影響 H_I
  ↓ C - H_I = C_I（移除產業）
  ↓
產業中性特徵 C_I
  ↓ [全市場 GAT] 學習市場影響 H_U
  ↓ C_I - H_U = C_U（移除市場）
  ↓
全市場中性特徵 C_U（純個股）
```

### 金融意義

```
市場漲 +1% + 產業漲 +1% + 個股漲 +1.5% = 總報酬 +3.5%

中性化後，只預測：個股 +1.5%
→ 更穩定、更有意義、泛化能力更強
```

### 技術優勢

1. **非線性**：GAT 學習複雜關係
2. **自適應**：注意力權重自動調整
3. **階層式**：逐層剝離，更乾淨
4. **多層次**：拼接三種特徵，兼顧全局與局部

---

這就是 DMFM 的核心創新！🎉
